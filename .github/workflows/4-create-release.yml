name: 4. Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      chart_version:
        description: 'Chart version'
        required: true
        type: string
      image_type:
        description: 'Image type'
        required: true
        type: string
      image_tag:
        description: 'Image tag'
        required: true
        type: string
      page_url:
        description: 'GitHub Pages URL'
        required: true
        type: string

permissions:
  contents: write

env:
  ECR_REGISTRY: 319867767576.dkr.ecr.ap-northeast-2.amazonaws.com

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.event.inputs.chart_version }}
        release_name: ğŸš€ nginx-chart-v${{ github.event.inputs.chart_version }}
        body: |
          ## ğŸš€ Helm Chart Release v${{ github.event.inputs.chart_version }}
          
          ### ğŸ“¦ Build Information
          - **Trigger**: Automated CI/CD Pipeline
          - **Image Type**: ${{ github.event.inputs.image_type }}
          - **Image Tag**: ${{ github.event.inputs.image_tag }}
          - **Chart Version**: ${{ github.event.inputs.chart_version }}
          - **ECR Image**: ${{ env.ECR_REGISTRY }}/nginx-${{ github.event.inputs.image_type }}:${{ github.event.inputs.image_tag }}
          - **Commit**: ${{ github.sha }}
          - **Helm Repository**: ${{ github.event.inputs.page_url }}
          
          ### ğŸ”§ Quick Installation
          ```bash
          helm repo add my-nginx https://bcgee.github.io/helm-nginx/
          helm repo update my-nginx
          helm upgrade --install my-nginx my-nginx/nginx --version ${{ github.event.inputs.chart_version }}
          ```
          
          ### ğŸ–¼ï¸ Image Details
          - **Base Image**: nginx:alpine
          - **Custom HTML**: ${{ github.event.inputs.image_type }} theme
          - **ECR Repository**: ${{ env.ECR_REGISTRY }}/nginx-${{ github.event.inputs.image_type }}
          - **Image Tag**: ${{ github.event.inputs.image_tag }}
          
          ### ğŸ“Š GitHub Pages
          - **Helm Repository**: ${{ github.event.inputs.page_url }}
          - **Charts Browser**: https://bcgee.github.io/helm-nginx/
          
          ### ğŸ”„ Pipeline Summary
          1. âœ… **Docker Image Built** - nginx:alpine + custom HTML
          2. âœ… **Image Pushed to ECR** - ${{ env.ECR_REGISTRY }}/nginx-${{ github.event.inputs.image_type }}:${{ github.event.inputs.image_tag }}
          3. âœ… **Helm Chart Updated** - Version ${{ github.event.inputs.chart_version }}
          4. âœ… **GitHub Pages Deployed** - ${{ github.event.inputs.page_url }}
          5. âœ… **Release Created** - This release!
          
          ### ğŸš€ What's Next?
          - Deploy to your Kubernetes cluster using the installation commands above
          - Use ArgoCD for GitOps deployment
          - Monitor your application with the included HPA and PDB resources
          
          ---
          
          **ğŸ¤– This release was automatically created by GitHub Actions**
        draft: false
        prerelease: false
        
    - name: Pipeline Summary
      run: |
        echo "ğŸ‰ CI/CD Pipeline Completed Successfully!"
        echo ""
        echo "ğŸ“‹ Summary:"
        echo "  â€¢ Image: ${{ github.event.inputs.image_type }}:${{ github.event.inputs.image_tag }}"
        echo "  â€¢ Chart: v${{ github.event.inputs.chart_version }}"
        echo "  â€¢ ECR: ${{ env.ECR_REGISTRY }}/nginx-${{ github.event.inputs.image_type }}:${{ github.event.inputs.image_tag }}"
        echo "  â€¢ Pages: ${{ github.event.inputs.page_url }}"
        echo "  â€¢ Release: v${{ github.event.inputs.chart_version }}"
        echo ""
        echo "âœ… All workflows completed successfully!" 